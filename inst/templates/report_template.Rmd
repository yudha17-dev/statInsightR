---
title: "Regression Model Report"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
params:
  model: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(knitr)
library(kableExtra)
library(statInsightR)

m <- params$model

safe_kable <- function(df) {
  if (is.null(df) || nrow(df) == 0 || ncol(df) == 0) {
    cat("No valid results available for this test.
")
    return(invisible(NULL))
  }
  kable(df, format = "html") %>% kable_styling(full_width = FALSE)
}
```

# Overview
This document provides a complete statistical report for the fitted regression model.

**Model Formula:**

```{r}
m$call
```

# Clean Summary

```{r}
summary_clean(m)
```

# Statistical Diagnostics

## Multicollinearity (VIF)

```{r}
library(car)
vif_res <- try(vif(m), silent = TRUE)

if (inherits(vif_res, "try-error") || length(vif_res) == 0) {
  cat("VIF cannot be computed for this model.
")
} else if (length(names(vif_res)) != length(vif_res)) {
  cat("VIF results invalid for this model.
")
} else {
  df_vif <- data.frame(
    Variable = names(vif_res),
    VIF = round(vif_res, 3)
  )
  safe_kable(df_vif)
}
```

## Normality of Residuals (Shapiro-Wilk Test)

```{r}
sh <- try(shapiro.test(residuals(m)), silent = TRUE)

if (inherits(sh, "try-error") || is.null(sh$statistic) || is.null(sh$p.value)) {
  cat("Shapiro-Wilk test could not be computed for this model.
")
} else {
  df_sh <- data.frame(
    Statistic = unname(sh$statistic),
    p_value = unname(sh$p.value)
  )
  safe_kable(df_sh)
}
```

## Heteroskedasticity (Breusch–Pagan Test)

```{r}
library(lmtest)
bp <- try(bptest(m), silent = TRUE)

if (inherits(bp, "try-error") || is.null(bp$statistic) || is.null(bp$p.value)) {
  cat("Breusch–Pagan test could not be computed for this model.
")
} else {
  df_bp <- data.frame(
    Statistic = unname(bp$statistic),
    p_value = unname(bp$p.value)
  )
  safe_kable(df_bp)
}
```

## Influential Points (Cook’s Distance)

```{r}
ci <- try(cooks.distance(m), silent = TRUE)

if (inherits(ci, "try-error") || length(ci) == 0 || all(is.na(ci))) {
  cat("Cook's distance cannot be computed for this model.
")
} else {
  n <- length(ci)
  influence_flag <- ci > (4/n)

  if (length(influence_flag) == length(ci)) {
    df_ci <- data.frame(
      Index = seq_along(ci),
      Cook = ci,
      Influential = ifelse(influence_flag, "Yes", "No")
    )

    df_ci <- df_ci[order(-df_ci$Cook), ]

    cat("### Top 10 Most Influential Points

")
    safe_kable(head(df_ci, 10))

  } else {
    cat("Influence diagnostics unavailable.
")
  }
}
```

<details>
<summary><strong>Click to expand full Cook’s Distance table (all points)</strong></summary>

<br>

```{r}
if (exists("df_ci")) safe_kable(df_ci) else cat("No Cook's distance table available.
")
```
</details>

# Diagnostic Plots

## Residuals vs Fitted

```{r}
plot(m, which = 1)
```

## Normal Q–Q Plot

```{r}
plot(m, which = 2)
```

## Cook’s Distance Plot

```{r}
plot(m, which = 4)
```

# Conclusion

```{r}
cat(statInsightR::auto_conclusion(m))
```

This report was generated using **statInsightR**.
